---
title: "Fatal Police Shootings"
author: "Devin Luu"
resource_files:
- .Renviron
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.world)
library(shiny)
library(gridExtra)
library(MASS)
library(ROCR)  
knitr::opts_chunk$set(echo = TRUE)
```
  
## **R Session Info**  

```{r}
sessionInfo()
```

## **Github Link** 
TBD

## **Introduction** 
Some Introduction.

## **Getting data from data.world** 
Short description of the data.
```{r}
project <- "https://data.world/devtl/fatalpoliceshootings/"
data.world::set_config(cfg_env("DW_API"))
df <- data.world::query(data.world::qry_sql("SELECT * FROM fatalPoliceShootingsCleaned"), dataset = project)

summary(df)
```

## Possible classifications

This dataset has many qualitative variables that could do well for classification methods. I am interested in predicting a victim's threat level based on age, whether or not they are armed, age, gender, race, whether or not they are fleeing, and signs of mental illness.

```{r}
predictors <- df%>%dplyr::select("armed","age","gender","race","signs_of_mental_illness","flee")

# signs of mental illness: 1=T, 0=F
x <- factor(rep(predictors$signs_of_mental_illness))
levels(x) <- 0:1
predictors$signs_of_mental_illness = x

# fleeing: 3=car, 2=foot, 1=other, 0=not fleeing
y <- factor(rep(predictors$flee))
levels(y) = c(3,2,0,1)
predictors$flee <- y

# gender: 1=M, 0=F
w <- factor(rep(predictors$gender))
levels(w) <- 0:1
predictors$gender = w

# armed=1 or unarmed=0
z <- unlist(
lapply(
predictors$armed, function(s){ifelse(s == "unarmed", as.integer(0), as.integer(1))}
)
)
predictors <- predictors %>% mutate(armedOrUnarmed = z)
renderTable(head(predictors), hover = TRUE, width = "auto")
```

Value Mappings:

* signs of mental illness: 1=T, 0=F

* fleeing: 3=car, 2=foot, 1=other, 0=not fleeing

* gender: 1=M, 0=F

* armed=1 or unarmed=0

## Traing/Testing

```{r}
### TRAIN/TEST 
df1 <- cbind(threat = df$threat_level,predictors)
train <- sample(1:nrow(df1), 0.9*nrow(df1))
testDf <- na.omit(df1[-train,])
trainDf <- na.omit(df1[train,])
```

## Classification Methods

### Logistic Regression
```{r}
# after filtering out a class level since lr is a binomial method.
df2 <- filter(df1, threat != "undetermined")
testDf2 <- filter(testDf, threat != "undetermined")
testDf2$threat <- factor(testDf2$threat) # removes "undetermined" level from testDf2

train2 <- rownames(
  filter(trainDf, 
         threat != "undetermined")
  )

### LOG REGRESSION
logFit1 = glm(threat ~ signs_of_mental_illness + armedOrUnarmed, 
            data = df2, 
            family = binomial, 
            subset = train2)

summary(logFit1)
logProb1 <- predict(logFit1, newdata = testDf2, type="response")

# label classes based on probability threshold for 'other'
logPred1 <- rep("attack", length(logProb1))

logPred1[logProb1 > 0.5] <- "other"
testGroup1 = testDf2$threat
table(logPred1, testGroup1)

logTestErr <- 1- mean(logPred1 == testGroup1)
```
The test error for the given LDA model is `r format(logTestErr, digits = 2)`.

```{r}
### ROC curve
pred <- prediction(logProb1, testGroup1)    
perf <- performance(pred, measure = "tpr", x.measure = "fpr") 
renderPlot({
  plot(perf, col=rainbow(7), main="ROC curve Theat Levels", xlab="Specificity (False Positives)", ylab="Sensitivity (True Positives)")
  
  abline(0, 1)
})

```


### LDA

```{r}
### LDA
lda.fit <- lda(threat ~ signs_of_mental_illness + armedOrUnarmed, data = df1, subset = train)

lda.fit

ldaPred <- data.frame(predict(lda.fit,testDf))

#renderTable({head(ldaPred)})

renderPlot({
  ggplot(ldaPred, mapping = aes(x.LD1, x.LD2, color = class)) + geom_point(alpha = 0.7) + theme_minimal() + labs(x = "LD1", y = "LD2")
})


testGroup = testDf$threat
ldaClass=ldaPred$class

pivotTab <- table(ldaClass, testGroup)

ldaTestErr <- 1 - mean(ldaClass == testGroup)

pivotTab

```

The test error for the given LDA model is `r format(ldaTestErr, digits = 2)`.

## Quadratic Discriminant Analysis
```{r}
qda.fit <- qda(threat ~ signs_of_mental_illness + armedOrUnarmed, data = df1, subset = train)

qda.fit

qdaPred <- data.frame(predict(qda.fit,testDf))

qdaClass <- qdaPred$class
testGroup = testDf$threat
table(qdaClass, testGroup)

qdaTestErr <- 1 - mean(qdaClass == testGroup)
```
The test error for the given LDA model is `r format(qdaTestErr, digits = 2)`.

## K Nearest-Neighbors


